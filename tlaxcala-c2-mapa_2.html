<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Tlaxcala ‚Äî C2 Cobertura por Etapas</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;600;700&family=Lato:wght@300;400;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<style>
  :root {
    --bg:#0f0e17; --panel:rgba(15,14,23,0.96); --border:rgba(255,255,255,0.1); --text:#e8e6f0; --muted:#7a7890;
    --e1:#3B82F6; --e1-bg:rgba(59,130,246,0.18);
    --e2:#A855F7; --e2-bg:rgba(168,85,247,0.18);
    --e3:#22C55E; --e3-bg:rgba(34,197,94,0.18);
    --e4v:#F59E0B; --e4v-bg:rgba(245,158,11,0.18);
    --e4p:#EF4444; --e4p-bg:rgba(239,68,68,0.18);
  }
  *{margin:0;padding:0;box-sizing:border-box;}
  body{font-family:'Lato',sans-serif;background:var(--bg);color:var(--text);height:100vh;display:flex;flex-direction:column;overflow:hidden;}

  header{background:linear-gradient(135deg,#0a0914,#15122a,#0a0914);border-bottom:1px solid rgba(168,85,247,0.4);padding:0 20px;height:56px;display:flex;align-items:center;justify-content:space-between;z-index:1000;flex-shrink:0;}
  .header-left{display:flex;align-items:center;gap:12px;}
  .logo{width:36px;height:36px;background:linear-gradient(135deg,#A855F7,#3B82F6);border-radius:8px;display:flex;align-items:center;justify-content:center;font-size:17px;box-shadow:0 0 16px rgba(168,85,247,0.35);}
  h1{font-family:'Cinzel',serif;font-size:16px;font-weight:700;color:#fff;letter-spacing:2px;}
  h1 span{display:block;font-size:9px;font-weight:400;letter-spacing:4px;color:var(--muted);margin-top:1px;}

  .legend-pills{display:flex;gap:6px;flex-wrap:wrap;align-items:center;}
  .pill{display:flex;align-items:center;gap:5px;padding:4px 10px;border-radius:20px;font-size:11px;font-weight:700;letter-spacing:0.5px;border:1.5px solid;cursor:pointer;transition:opacity 0.2s;user-select:none;}
  .pill.faded{opacity:0.28;}
  .pill-dot{width:8px;height:8px;border-radius:50%;flex-shrink:0;}
  .pill-e1{color:var(--e1);border-color:var(--e1);background:var(--e1-bg);}
  .pill-e2{color:var(--e2);border-color:var(--e2);background:var(--e2-bg);}
  .pill-e3{color:var(--e3);border-color:var(--e3);background:var(--e3-bg);}
  .pill-e4v{color:var(--e4v);border-color:var(--e4v);background:var(--e4v-bg);}
  .pill-e4p{color:var(--e4p);border-color:var(--e4p);background:var(--e4p-bg);}
  .pill-n{color:#9ca3af;border-color:#4B5563;background:rgba(75,85,99,0.18);}

  .main{display:flex;flex:1;overflow:hidden;}
  #map{flex:1;position:relative;}

  .panel{width:285px;background:var(--panel);border-left:1px solid var(--border);display:flex;flex-direction:column;overflow:hidden;flex-shrink:0;}
  .panel-tabs{display:flex;border-bottom:1px solid var(--border);}
  .tab{flex:1;padding:10px 6px;text-align:center;font-size:11px;font-weight:700;letter-spacing:1px;text-transform:uppercase;cursor:pointer;color:var(--muted);border-bottom:2px solid transparent;transition:all 0.2s;}
  .tab.active{color:#A855F7;border-bottom-color:#A855F7;}

  .tab-content{display:none;flex-direction:column;flex:1;overflow:hidden;}
  .tab-content.active{display:flex;}

  .search-wrap{padding:10px 12px;border-bottom:1px solid var(--border);}
  .search-wrap input{width:100%;background:rgba(255,255,255,0.05);border:1px solid var(--border);border-radius:6px;padding:7px 12px;color:var(--text);font-size:12px;outline:none;transition:border-color 0.2s;font-family:'Lato',sans-serif;}
  .search-wrap input:focus{border-color:#A855F7;}
  .search-wrap input::placeholder{color:var(--muted);}

  .muni-list{flex:1;overflow-y:auto;padding:4px 0;}
  .muni-list::-webkit-scrollbar{width:3px;}
  .muni-list::-webkit-scrollbar-thumb{background:rgba(168,85,247,0.4);border-radius:2px;}

  .muni-item{padding:7px 12px;cursor:pointer;border-left:3px solid transparent;transition:all 0.15s;display:flex;align-items:center;gap:8px;}
  .muni-item:hover{background:rgba(255,255,255,0.04);}
  .muni-item.active{background:rgba(168,85,247,0.1);}

  .muni-badge{font-size:9px;font-weight:700;padding:2px 6px;border-radius:10px;letter-spacing:0.5px;flex-shrink:0;}
  .muni-name{font-size:12px;flex:1;line-height:1.3;}
  .muni-note-icon{font-size:11px;opacity:0.7;flex-shrink:0;}

  .info-section{padding:14px;border-bottom:1px solid var(--border);flex-shrink:0;}
  .info-section h3{font-family:'Cinzel',serif;font-size:13px;margin-bottom:8px;line-height:1.4;}
  .info-tag{display:inline-flex;align-items:center;gap:6px;padding:4px 10px;border-radius:20px;font-size:11px;font-weight:700;margin-bottom:8px;border:1.5px solid;}
  .info-rows{font-size:12px;color:var(--muted);line-height:1.9;}
  .info-rows strong{color:var(--text);}

  .notes-section{padding:14px;flex:1;display:flex;flex-direction:column;gap:8px;overflow:hidden;}
  .notes-label{font-size:10px;font-weight:700;letter-spacing:2px;text-transform:uppercase;color:var(--muted);}
  .notes-textarea{flex:1;min-height:80px;background:rgba(255,255,255,0.04);border:1px solid var(--border);border-radius:6px;padding:10px;color:var(--text);font-family:'Lato',sans-serif;font-size:12px;line-height:1.6;resize:none;outline:none;transition:border-color 0.2s;}
  .notes-textarea:focus{border-color:#A855F7;}
  .notes-textarea::placeholder{color:var(--muted);font-style:italic;}
  .save-btn{padding:8px;background:linear-gradient(135deg,#7c3aed,#3b82f6);border:none;border-radius:6px;color:#fff;font-family:'Lato',sans-serif;font-size:12px;font-weight:700;letter-spacing:1px;cursor:pointer;transition:opacity 0.2s;flex-shrink:0;}
  .save-btn:hover{opacity:0.85;}
  .save-btn.saved{background:linear-gradient(135deg,#16a34a,#22c55e);}

  .no-selection{flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;color:var(--muted);font-size:12px;text-align:center;padding:20px;gap:8px;}
  .no-selection .big{font-size:28px;}

  .stats-bar{padding:8px 14px;border-top:1px solid var(--border);background:rgba(0,0,0,0.3);font-size:11px;color:var(--muted);display:flex;gap:10px;flex-wrap:wrap;flex-shrink:0;}
  .stat-chip{display:flex;align-items:center;gap:5px;}
  .stat-dot{width:7px;height:7px;border-radius:50%;}

  #loading{position:absolute;inset:0;background:rgba(10,9,20,0.95);display:flex;flex-direction:column;align-items:center;justify-content:center;z-index:2000;}
  .loader-ring{width:48px;height:48px;border:3px solid rgba(168,85,247,0.2);border-top-color:#A855F7;border-radius:50%;animation:spin 0.9s linear infinite;margin-bottom:14px;}
  @keyframes spin{to{transform:rotate(360deg);}}
  .loader-text{font-family:'Cinzel',serif;font-size:11px;letter-spacing:3px;color:#A855F7;}
  .loader-sub{font-size:10px;color:var(--muted);margin-top:8px;}

  .leaflet-container{background:#080710;}
  .leaflet-popup-content-wrapper{background:#15122a;border:1px solid rgba(168,85,247,0.5);border-radius:8px;color:var(--text);box-shadow:0 8px 32px rgba(0,0,0,0.8);}
  .leaflet-popup-tip{background:rgba(168,85,247,0.5);}
  .leaflet-popup-content{margin:12px 16px;font-family:'Lato',sans-serif;}
  .leaflet-tooltip{background:#15122a;border:1px solid rgba(168,85,247,0.5);color:var(--text);font-family:'Lato',sans-serif;font-size:12px;font-weight:700;padding:5px 10px;border-radius:4px;box-shadow:0 4px 16px rgba(0,0,0,0.6);white-space:nowrap;}
  .leaflet-control-zoom a{background:#15122a !important;color:#A855F7 !important;border-color:rgba(168,85,247,0.3) !important;}
  .leaflet-control-zoom a:hover{background:rgba(168,85,247,0.15) !important;}

  .hidden{display:none !important;}
  @media(max-width:640px){.panel,.legend-pills{display:none;}}
</style>
</head>
<body>

<header>
  <div class="header-left">
    <div class="logo">üì°</div>
    <h1>TLAXCALA C2<span>COBERTURA POR ETAPAS ¬∑ 2023‚Äì2026</span></h1>
  </div>
  <div class="legend-pills">
    <div class="pill pill-e1" onclick="toggleFilter('e1')"><div class="pill-dot" style="background:var(--e1)"></div>1¬™ Etapa 2023</div>
    <div class="pill pill-e2" onclick="toggleFilter('e2')"><div class="pill-dot" style="background:var(--e2)"></div>2¬™ Etapa 2024</div>
    <div class="pill pill-e3" onclick="toggleFilter('e3')"><div class="pill-dot" style="background:var(--e3)"></div>3¬™ Etapa 2025</div>
    <div class="pill pill-e4v" onclick="toggleFilter('e4v')"><div class="pill-dot" style="background:var(--e4v)"></div>4¬™ Etapa ‚úì</div>
    <div class="pill pill-e4p" onclick="toggleFilter('e4p')"><div class="pill-dot" style="background:var(--e4p)"></div>4¬™ Etapa ‚è≥</div>
    <div class="pill pill-n" onclick="toggleFilter('none')"><div class="pill-dot" style="background:#6B7280"></div>Sin asignar</div>
  </div>
</header>

<div class="main">
  <div id="map">
    <div id="loading">
      <div class="loader-ring"></div>
      <div class="loader-text">CARGANDO MUNICIPIOS‚Ä¶</div>
      <div class="loader-sub" id="loadSub">Conectando a OpenStreetMap‚Ä¶</div>
    </div>
  </div>
  <div class="panel">
    <div class="panel-tabs">
      <div class="tab active" onclick="showTab('list')">üìã Lista</div>
      <div class="tab" onclick="showTab('info')">üìç Detalle</div>
    </div>
    <div class="tab-content active" id="tab-list">
      <div class="search-wrap">
        <input type="text" id="searchInput" placeholder="üîç  Buscar municipio...">
      </div>
      <div class="muni-list" id="muniList"></div>
      <div class="stats-bar" id="statsBar"></div>
    </div>
    <div class="tab-content" id="tab-info">
      <div id="infoContent">
        <div class="no-selection">
          <div class="big">üó∫Ô∏è</div>
          <div>Selecciona un municipio<br>en el mapa o en la lista</div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// DATOS ‚Äî Nombres exactos seg√∫n OSM
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const ETAPAS = {
  // 1¬™ Etapa 2023
  'Apizaco':                                   {etapa:1},
  'Calpulalpan':                               {etapa:1},
  'El Carmen Tequexquitla':                   {etapa:1},
  'Huamantla':                                {etapa:1},
  'Ixtacuixtla de Mariano Matamoros':         {etapa:1},
  'Nanacamilpa de Mariano Arista':            {etapa:1},
  'Nat√≠vitas':                                {etapa:1},
  'Apetatitl√°n de Antonio Carvajal':          {etapa:1},
  'San Pablo del Monte':                      {etapa:1},
  'Papalotla de Xicoht√©ncatl':               {etapa:1},
  'Tenancingo':                               {etapa:1},
  'Zacatelco':                                {etapa:1},
  'Tlaxco':                                   {etapa:1},

  // 2¬™ Etapa 2024
  'Amaxac de Guerrero':                       {etapa:2},
  'Atlangatepec':                             {etapa:2},
  'Chiautempan':                              {etapa:2},
  'Emiliano Zapata':                          {etapa:2},
  'Ixtenco':                                  {etapa:2},
  'Mu√±oz de Domingo Arenas':                 {etapa:2},
  'Panotla':                                  {etapa:2},
  'San Jer√≥nimo Zacualpan':                  {etapa:2},
  'San Jos√© Teacalco':                        {etapa:2},
  'Sanct√≥rum de L√°zaro C√°rdenas':            {etapa:2},
  'Santa Apolonia Teacalco':                 {etapa:2},
  'Santa Catarina Ayometla':                 {etapa:2},
  'Xaloztoc':                                 {etapa:2},
  'Teolocholco':                              {etapa:2},
  'Tepetitla de Lardiz√°bal':                 {etapa:2},
  'Tetla de la Solidaridad':                 {etapa:2},
  'Municipio de Tlaxcala':                   {etapa:2},  // nombre OSM
  'Tocatl√°n':                                {etapa:2},
  'Tzompantepec':                             {etapa:2},
  'Yauhquemehcan':                            {etapa:2},
  'Ziltlalt√©pec de Trinidad S√°nchez Santos': {etapa:2},

  // 3¬™ Etapa 2025
  'Cuapiaxtla':                               {etapa:3},
  'Espa√±ita':                                 {etapa:3},
  'La Magdalena Tlaltelulco':                {etapa:3},
  'San Francisco Tetlanohcan':               {etapa:3},
  'Santa Cruz Tlaxcala':                     {etapa:3},
  'Santa Isabel Xiloxoxtla':                {etapa:3},
  'Xicohtzinco':                              {etapa:3},  // Santo Toribio Xocohtzinco
  'Tepeyanco':                                {etapa:3},
  'Totolac':                                  {etapa:3},
  'Terrenate':                                {etapa:3},
  'San Dami√°n Tex√≥loc':                      {etapa:3},  // Texoloc
  'San Juan Huactzinco':                     {etapa:3},
  'Tetlatlahuca':                             {etapa:3},
  'San Lorenzo Axocomanitla':                {etapa:3},  // ‚Üê AXOCOMANITLA (nombre completo OSM)

  // 4¬™ Etapa 2026 ‚Äî Visitados
  'Acuamanala de Miguel Hidalgo':            {etapa:4, visitado:true},
  'Atltzayanca':                             {etapa:4, visitado:true},
  'Cuaxomulco':                              {etapa:4, visitado:true},
  'Hueyotlipan':                             {etapa:4, visitado:true},  // ‚Üê OSM usa UNA sola 'l'
  'Mazatecochco de Jos√© Mar√≠a Morelos':      {etapa:4, visitado:true},
  'Santa Cruz Quilehtla':                    {etapa:4, visitado:true},
  'San Lucas Tecopilco':                     {etapa:4, visitado:true},
  'Santa Ana Nopalucan':                     {etapa:4, visitado:true},
  'Xaltocan':                                {etapa:4, visitado:true},
  'Benito Ju√°rez':                           {etapa:4, visitado:true},

  // 4¬™ Etapa 2026 ‚Äî Pendientes de visitar
  'Contla de Juan Cuamatzi':               {etapa:4, visitado:false},  // ‚Üê CONTLA
  'L√°zaro C√°rdenas':                       {etapa:4, visitado:false},
};

const STYLE_MAP = {
  e1:   {fillColor:'#3B82F6', label:'1¬™ Etapa 2023',    badge:'E1'},
  e2:   {fillColor:'#A855F7', label:'2¬™ Etapa 2024',    badge:'E2'},
  e3:   {fillColor:'#22C55E', label:'3¬™ Etapa 2025',    badge:'E3'},
  e4v:  {fillColor:'#F59E0B', label:'4¬™ Etapa 2026 ‚úì',  badge:'E4‚úì'},
  e4p:  {fillColor:'#EF4444', label:'4¬™ Etapa 2026 ‚è≥', badge:'E4‚è≥'},
  none: {fillColor:'#374151', label:'Sin asignar',      badge:'‚Äî'},
};

function getInfo(name) { return ETAPAS[name] || null; }
function getKey(info) {
  if (!info) return 'none';
  if (info.etapa===1) return 'e1';
  if (info.etapa===2) return 'e2';
  if (info.etapa===3) return 'e3';
  if (info.etapa===4 && info.visitado===false) return 'e4p';
  if (info.etapa===4) return 'e4v';
  return 'none';
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// MAPA
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const map = L.map('map', {center:[19.42,-98.18], zoom:10, zoomControl:true, attributionControl:false});
L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {subdomains:'abcd', maxZoom:18}).addTo(map);
L.control.attribution({prefix:'¬© OSM ¬∑ CartoDB'}).addTo(map);

let geojsonLayer=null, allFeatures=[], selectedLayer=null, selectedName=null;
const activeFilters = new Set();
let notes = {};
try { notes = JSON.parse(localStorage.getItem('tlaxcala_c2_notes')||'{}'); } catch(e){}
function saveNotes() { try{localStorage.setItem('tlaxcala_c2_notes',JSON.stringify(notes));}catch(e){} }

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// FETCH CON FALLBACK A M√öLTIPLES SERVIDORES
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const ENDPOINTS = [
  'https://overpass-api.de/api/interpreter',
  'https://overpass.kumi.systems/api/interpreter',
  'https://overpass.openstreetmap.ru/api/interpreter',
];
const QUERY = `[out:json][timeout:60];area[name="Tlaxcala"]["admin_level"="4"]->.s;(relation["admin_level"="6"]["boundary"="administrative"](area.s););out geom;`;

async function fetchOverpass(url) {
  const res = await fetch(url, {
    method:'POST', body:'data='+encodeURIComponent(QUERY),
    headers:{'Content-Type':'application/x-www-form-urlencoded'}
  });
  if (!res.ok) throw new Error(`HTTP ${res.status}`);
  const txt = await res.text();
  if (txt.trim()[0]==='<') throw new Error('Rate limit o error del servidor');
  return JSON.parse(txt);
}

async function fetchWithFallback() {
  for (let i=0; i<ENDPOINTS.length; i++) {
    try {
      document.getElementById('loadSub').textContent = `Servidor ${i+1}/${ENDPOINTS.length}‚Ä¶`;
      return await fetchOverpass(ENDPOINTS[i]);
    } catch(e) {
      console.warn(`Servidor ${i+1} fall√≥:`, e.message);
      if (i===ENDPOINTS.length-1) throw e;
      await new Promise(r=>setTimeout(r,1800));
    }
  }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// GEOJSON PARSER
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function overpassToGeoJSON(data) {
  const features = [];
  for (const el of data.elements) {
    if (el.type!=='relation') continue;
    const name = el.tags?.name||'Sin nombre';
    const oW=[],iW=[];
    for (const m of el.members||[]) {
      if (m.type==='way'&&m.geometry) {
        const c=m.geometry.map(p=>[p.lon,p.lat]);
        (m.role==='inner'?iW:oW).push(c);
      }
    }
    if (!oW.length) continue;
    const outer=mergeWays(oW), inner=mergeWays(iW);
    const geo = outer.length===1
      ? {type:'Polygon', coordinates:[outer[0],...inner]}
      : {type:'MultiPolygon', coordinates:outer.map(r=>[r])};
    features.push({type:'Feature', properties:{name,...el.tags}, geometry:geo});
  }
  return {type:'FeatureCollection', features};
}

function eq(a,b){return Math.abs(a[0]-b[0])<1e-5&&Math.abs(a[1]-b[1])<1e-5;}
function mergeWays(ways) {
  if (!ways.length) return [];
  if (ways.length===1) return [ways[0]];
  const rings=[],rem=ways.map(w=>[...w]);
  while (rem.length) {
    let ring=rem.shift(), changed=true;
    while (changed) {
      changed=false;
      for (let i=0;i<rem.length;i++) {
        const w=rem[i],rE=ring[ring.length-1],rS=ring[0];
        if      (eq(rE,w[0]))          {ring=[...ring,...w.slice(1)];}
        else if (eq(rE,w[w.length-1])) {ring=[...ring,...w.slice(0,-1).reverse()];}
        else if (eq(rS,w[w.length-1])) {ring=[...w,...ring.slice(1)];}
        else if (eq(rS,w[0]))          {ring=[...w.reverse(),...ring.slice(1)];}
        else continue;
        rem.splice(i,1);changed=true;break;
      }
    }
    rings.push(ring);
  }
  return rings;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// UI
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function showTab(id) {
  document.querySelectorAll('.tab-content').forEach(t=>t.classList.remove('active'));
  document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
  document.getElementById('tab-'+id).classList.add('active');
  document.querySelectorAll('.tab')[id==='list'?0:1].classList.add('active');
}

function buildList(features) {
  const list=document.getElementById('muniList');
  list.innerHTML='';
  [...features].sort((a,b)=>a.properties.name.localeCompare(b.properties.name,'es')).forEach(f=>{
    const name=f.properties.name,info=getInfo(name),key=getKey(info),style=STYLE_MAP[key];
    const hasNote=notes[name]?.trim();
    const item=document.createElement('div');
    item.className='muni-item'; item.dataset.name=name; item.dataset.key=key;
    item.style.borderLeftColor=key!=='none'?style.fillColor:'transparent';
    item.innerHTML=`
      <span class="muni-badge" style="background:${style.fillColor}22;color:${style.fillColor};border:1px solid ${style.fillColor}55">${style.badge}</span>
      <span class="muni-name">${name}</span>
      ${hasNote?'<span class="muni-note-icon" title="Tiene nota">üìù</span>':''}`;
    item.addEventListener('click',()=>selectMunicipio(name));
    list.appendChild(item);
  });
  updateStats();
}

function updateStats() {
  const c={e1:0,e2:0,e3:0,e4v:0,e4p:0,none:0};
  document.querySelectorAll('.muni-item').forEach(el=>{if(el.style.display!=='none') c[el.dataset.key]++;});
  document.getElementById('statsBar').innerHTML=Object.entries(c).filter(([,v])=>v>0)
    .map(([k,v])=>`<div class="stat-chip"><div class="stat-dot" style="background:${STYLE_MAP[k].fillColor}"></div><span>${v}</span></div>`).join('');
}

function nrm(s){return s.toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g,'');}

document.getElementById('searchInput').addEventListener('input',function(){
  const q=nrm(this.value);
  document.querySelectorAll('.muni-item').forEach(el=>{
    const match=nrm(el.dataset.name).includes(q)&&(activeFilters.size===0||activeFilters.has(el.dataset.key));
    el.style.display=match?'':'none';
  });
  updateStats();
});

function toggleFilter(key) {
  activeFilters.has(key)?activeFilters.delete(key):activeFilters.add(key);
  document.querySelectorAll('.pill').forEach(p=>{
    const pk=[...p.classList].find(c=>c.startsWith('pill-')&&c!=='pill')?.replace('pill-','');
    if(pk) p.classList.toggle('faded',activeFilters.size>0&&!activeFilters.has(pk));
  });
  const q=nrm(document.getElementById('searchInput').value);
  document.querySelectorAll('.muni-item').forEach(el=>{
    el.style.display=(nrm(el.dataset.name).includes(q)&&(activeFilters.size===0||activeFilters.has(el.dataset.key)))?'':'none';
  });
  updateStats();
  geojsonLayer?.eachLayer(layer=>{
    const k=getKey(getInfo(layer.feature?.properties?.name));
    const show=activeFilters.size===0||activeFilters.has(k);
    layer.setStyle({fillOpacity:show?0.65:0.07,opacity:show?1:0.25});
  });
  if(selectedLayer) selectedLayer.setStyle({fillOpacity:0.85,weight:3,color:'#fff',opacity:1});
}

function selectMunicipio(name) {
  selectedName=name;
  document.querySelectorAll('.muni-item').forEach(el=>el.classList.toggle('active',el.dataset.name===name));
  document.querySelector('.muni-item.active')?.scrollIntoView({block:'nearest'});
  geojsonLayer?.eachLayer(layer=>{
    if(layer.feature?.properties?.name===name){
      map.fitBounds(layer.getBounds(),{padding:[50,50],maxZoom:13});
      highlightLayer(layer);
    }
  });
  renderInfoPanel(name); showTab('info');
}

function highlightLayer(layer) {
  if(selectedLayer&&selectedLayer!==layer){
    const k=getKey(getInfo(selectedLayer.feature?.properties?.name));
    const show=activeFilters.size===0||activeFilters.has(k);
    selectedLayer.setStyle({fillOpacity:show?0.65:0.07,weight:1,color:'rgba(255,255,255,0.15)'});
  }
  selectedLayer=layer;
  layer.setStyle({fillOpacity:0.85,weight:3,color:'#fff'}); layer.bringToFront();
}

function renderInfoPanel(name) {
  const info=getInfo(name), key=getKey(info), style=STYLE_MAP[key], note=notes[name]||'';
  const yr={1:'2023',2:'2024',3:'2025',4:'2026'};
  const etLbl=info?`${info.etapa}¬™ Etapa ${yr[info.etapa]}`:'‚Äî';
  const statusHtml=key==='e4p'
    ?`<div style="color:#EF4444;font-size:11px;margin-top:6px;font-weight:700">‚è≥ Pendiente de visitar</div>`
    :key==='e4v'
    ?`<div style="color:#F59E0B;font-size:11px;margin-top:6px;font-weight:700">‚úÖ Visitado</div>`
    :'';

  document.getElementById('infoContent').innerHTML=`
    <div class="info-section">
      <h3>${name}</h3>
      <div class="info-tag" style="color:${style.fillColor};border-color:${style.fillColor};background:${style.fillColor}18">
        <span>‚óè</span>${style.label}
      </div>
      ${statusHtml}
      <div class="info-rows" style="margin-top:8px">
        <strong>Etapa:</strong> ${etLbl}<br>
        <strong>Estado:</strong> Tlaxcala, M√©xico
      </div>
    </div>
    <div class="notes-section">
      <div class="notes-label">üìù Notas del municipio</div>
      <textarea class="notes-textarea" id="noteArea" placeholder="Escribe observaciones, contactos, pendientes‚Ä¶">${note}</textarea>
      <button class="save-btn" id="saveBtn" onclick="saveNote()">GUARDAR NOTA</button>
    </div>`;
}

function saveNote() {
  if(!selectedName) return;
  const text=document.getElementById('noteArea')?.value||'';
  notes[selectedName]=text; saveNotes();
  const btn=document.getElementById('saveBtn');
  btn.textContent='‚úì GUARDADO'; btn.classList.add('saved');
  setTimeout(()=>{btn.textContent='GUARDAR NOTA';btn.classList.remove('saved');},2000);
  const item=document.querySelector(`.muni-item[data-name="${CSS.escape(selectedName)}"]`);
  if(item){
    const ex=item.querySelector('.muni-note-icon');
    if(text.trim()&&!ex) item.insertAdjacentHTML('beforeend','<span class="muni-note-icon" title="Tiene nota">üìù</span>');
    else if(!text.trim()&&ex) ex.remove();
  }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// MAIN
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function main() {
  document.getElementById('loading').classList.remove('hidden');
  try {
    const data=await fetchWithFallback();
    const geojson=overpassToGeoJSON(data);
    allFeatures=geojson.features;
    buildList(allFeatures);

    geojsonLayer=L.geoJSON(geojson,{
      style: feature=>{
        const k=getKey(getInfo(feature.properties.name));
        return {fillColor:STYLE_MAP[k].fillColor,fillOpacity:0.65,color:'rgba(255,255,255,0.15)',weight:1};
      },
      onEachFeature:(feature,layer)=>{
        const name=feature.properties.name, info=getInfo(name), key=getKey(info), style=STYLE_MAP[key];
        layer.bindTooltip(
          `<b>${name}</b><br><span style="color:${style.fillColor}">${style.label}</span>`,
          {permanent:false,direction:'center',opacity:0.97}
        );
        layer.on({
          mouseover(){if(layer!==selectedLayer) layer.setStyle({fillOpacity:0.85,weight:2.5,color:'rgba(255,255,255,0.6)'}); },
          mouseout(){
            if(layer!==selectedLayer){
              const show=activeFilters.size===0||activeFilters.has(key);
              layer.setStyle({fillOpacity:show?0.65:0.07,weight:1,color:'rgba(255,255,255,0.15)'});
            }
          },
          click(){
            highlightLayer(layer); selectedName=name;
            document.querySelectorAll('.muni-item').forEach(el=>el.classList.toggle('active',el.dataset.name===name));
            document.querySelector('.muni-item.active')?.scrollIntoView({block:'nearest'});
            renderInfoPanel(name); showTab('info');
          }
        });
      }
    }).addTo(map);

    map.fitBounds(geojsonLayer.getBounds(),{padding:[16,16]});

  } catch(err) {
    document.getElementById('loading').innerHTML=`
      <div style="text-align:center;padding:24px;font-family:'Lato',sans-serif">
        <div style="font-size:36px;margin-bottom:12px">‚ö†Ô∏è</div>
        <div style="font-family:'Cinzel',serif;color:#A855F7;letter-spacing:2px;margin-bottom:8px">ERROR AL CARGAR</div>
        <div style="font-size:12px;color:#7a7890;margin-bottom:16px;max-width:280px">${err.message}</div>
        <button onclick="main()" style="padding:10px 28px;background:linear-gradient(135deg,#7c3aed,#3b82f6);border:none;border-radius:8px;color:#fff;font-family:'Cinzel',serif;font-size:13px;letter-spacing:2px;cursor:pointer">REINTENTAR</button>
      </div>`;
    return;
  }
  document.getElementById('loading').classList.add('hidden');
}

main();
</script>
</body>
</html>
